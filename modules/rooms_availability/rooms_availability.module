<?php

/**
 * @file
 * Manages availability for Rooms and displaying dates on the jquery FullCalendar
 * plugin
 */


/**
 * The default path to the FullCalendar plugin.
 */
define('FULLCALENDAR_PATH', 'sites/all/libraries/fullcalendar');

/**
 * The minimum supported version of the FullCalendar plugin.
 */
define('FULLCALENDAR_MIN_PLUGIN_VERSION', '1.4.10');


/**
 * Implements hook_library().
 */
function rooms_availability_library() {
  $libraries['rooms_fullcalendar'] = array(
    'title' => 'Rooms FullCalendar',
    'website' => 'http://arshaw.com/fullcalendar',
    'version' => FULLCALENDAR_MIN_PLUGIN_VERSION,
    'js' => array(
      rooms_availability_fullcalendar_get_js_path() => array(),
      variable_get('rooms_fullcalendar_path', FULLCALENDAR_PATH) . '/gcal.js' => array(),
    ),
    'css' => array(
      variable_get('rooms_fullcalendar_path', FULLCALENDAR_PATH) . '/fullcalendar.css' => array(
        'type' => 'file',
        'media' => 'screen',
      ),
      drupal_get_path('module', 'rooms_availability') . '/css/fullcalendar.theme.css' => array(
        'type' => 'file',
        'media' => 'screen',
      ),
    ),
    'dependencies' => array(
      array('system', 'ui.draggable'),
      array('system', 'ui.droppable'),
      array('system', 'ui.resizable'),
      array('system', 'effects.highlight'),
    ),
  );
  return $libraries;
}


/**
 * Implements hook_permission().
 */
function rooms_availability_permission() {
  $permissions = array(
    'manage room availablity' => array(
      'title' => t('manage rooms availability'),
      'description' => t('Allows users to manage availability settings for Rooms'),
      'restrict access' => TRUE,
    ),
  );
  return $permissions;
}


/**
 * Implements hook_menu().
 */
function rooms_availability_menu() {
  $items  =  array();
  
  $items['admin/rooms/rooms/room/%room/availability'] = array(
    'title' => 'Room Availability',
    'page callback' =>  'rooms_availability_page',
    'page arguments' => array(4),
    'access callback' => 'rooms_availability_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
    'weight' => '20',
  );
  
  $items['admin/rooms/rooms/room/ajax/%room/%action/%year/%month'] = array(
    'title' =>  'Availability Event',
    'page callback' => 'rooms_availability_event',
    'page arguments' => array(5,6,7,8),
    'access callback' => 'rooms_availability_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
  );

  $items['admin/rooms/rooms/room/ajax/test'] = array(
    'title' =>  'Availability Event Test',
    'page callback' => 'rooms_availability_event_test',
    'access arguments' => array('manage rooms availability'),
    'type' => MENU_CALLBACK,
  );
  
  $items['admin/rooms/calendartest'] = array(
    'title' => 'Calendar Tests',
    'page callback' => 'calendar_test',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  
  return $items;
}


function room_load($room_id){
  $room = rooms_room_load($room_id);
  return $room;
}


/**
 * Room availability access callback
 * @todo check unauthorised access for calendar js
 */ 
function rooms_availability_access($rooms_room) {
  if (user_access('manage room availability')) {
    return TRUE;
  }
  return 'FALSE';
}


/**
 * Callback for admin/rooms/rooms/room/%room/availability - builds availability
 * page by adding calendar and pulling events from availability table.
 * 
 */
function rooms_availability_page(RoomsRoom $rooms_room) {
  drupal_add_library('rooms_availability', 'rooms_fullcalendar');
  drupal_add_js(drupal_get_path('module', 'rooms_availability') . '/js/rooms_availability.js');
  drupal_add_js(array('roomId' => $rooms_room->room_id), 'setting');
  $output = theme('rooms_availability', array('name'=>$rooms_room->name, 'type'=>$rooms_room->type, 'update_form'=>drupal_get_form('update_calendar_form')));
  return $output;  
}


function update_calendar_form($form, &$form_state) {
  
  $form['date_range']['start_date'] = array(
    '#type' => 'date_popup',
    '#title' => t('Start Date'),
    '#date_type' => DATE_DATETIME,
    '#date_format' => 'm/d/Y',
    '#date_increment' => 1,
    '#date_year_range' => '-1:+3',
    '#required' => TRUE,
  );
  
  $form['date_range']['end_date'] = array(
    '#type' => 'date_popup',
    '#title' => t('End Date'),
    '#date_type' => DATE_DATETIME,
    '#date_format' => 'm/d/Y',
    '#date_increment' => 1,
    '#date_year_range' => '-1:+3',
    '#required' => TRUE,
  );
  
  
  $form['room_state'] = array(
    '#type' => 'select',
    '#title' => t('Room State'),
    '#options' => array(
      '0' => 'Available',
      '1' => 'Unavailable',
      '2' => 'Available on Request'
    ),
    '#description' => t('Choose what state to put the room in for the dates chosen above'),
  );
  
  $form['actions'] = array(
    '#type' => 'container',
    '#attributes' => array('class' => array('form-actions')),
    '#weight' => 400,
  );
  
  // We add the form's #submit array to this button along with the actual submit
  // handler to preserve any submit handlers added by a form callback_wrapper.
  $submit = array();

  if (!empty($form['#submit'])) {
    $submit += $form['#submit'];
  }
  
  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Update Room Availability'),
    '#submit' => $submit + array('update_calendar_form_submit'),
  );
  
  return $form;
}


function update_calendar_form_submit(&$form, &$form_state) {
  
}

/** 
 * Callback Test for json
 */
function rooms_availability_event_test() {
 
  $year = date('Y');
	$month = date('m');

	echo  drupal_json_encode(array(
	
		array(
			'id' => 111,
			'title' => "Mr and Ms Smith",
			'start' => "$year-$month-10",
			'url' => "http://google.com/"
		),
		
		array(
			'id' => 222,
			'title' => "Roger John",
			'start' => "$year-$month-20",
			'end' => "$year-$month-22",
			'url' => "http://google.com/",
      'color' => "red"
		),


		array(
			'id' => 223,
			'title' => "Roger John",
			'start' => "$year-$month-3",
			'end' => "$year-$month-8",
			'url' => "http://google.com/"
		),

	
	));
  
  //return $result;
}

 

/**
 * Implement rooms_availability_theme().
 */
function rooms_availability_theme() {
  return array(
    'rooms_availability' => array(
      'variables' => array('variable1', 'variable2'),
      'template' => 'rooms_availability'
    )
  );
}


/**
 * Returns the path to the FullCalendar plugin.
 */
function rooms_availability_fullcalendar_get_js_path() {
  $fullcalendar_file = array('none' => 'fullcalendar.js', 'min' => 'fullcalendar.min.js');
  return variable_get('rooms_fullcalendar_path', FULLCALENDAR_PATH) . '/' . $fullcalendar_file[variable_get('rooms_fullcalendar_compression_type', 'min')];
}


function calendar_test(){
  
  $room = rooms_room_load(2);
  
  $start_date = new DateTime;
  $start_date->setDate(2011,6,15);
  $start_date1 = new DateTime;
  $start_date1->setDate(2011,7,15);
  

  $end_date = new DateTime;
  $end_date->setDate(2011,10,15);
  $end_date1 = new DateTime;
  $end_date1->setDate(2011,7,23);
  
  
  $diff = $start_date->diff($end_date); 
    
  $event = new BookingEvent(1, 2, $start_date, $end_date);
  $event1 = new BookingEvent (1, 2,$start_date1, $end_date1 );
  //dpm($event);
  //dpm($event1);
  $events = array($event, $event1);
  
  $rc = new RoomCalendar(1,0);
  
  $rc->updateCalendar($events);
  //dpm($rc);
  
  $output = '';
  return $output;
}



/**
 * Handles quering and updating the availability information
 * relative to a single Room.
 */
class RoomCalendar {

  // The room the Calendar is relevant to  
  protected $room_id;
  
  // The default state for the room if it has no specific booking
  protected $default_state;
  
  
  public function __construct($room_id, $default_state){
    $this->room_id = $room_id;
    $this->default_state = $default_state;
  }
  
  
  
  
  /**
   * Given an array of events removes events from the calendar
   *
   * @param $events
   *    The events to remove from the database - an array of Booking Events
   *
   * @return
   *   The array of ids of events that were found and removed
   */
  public function removeEvents($events) {}
  
  
  /**
   * Given a date range tries to determine whether room is available for booking
   */
  public function checkAvailability(DateTime $start_date, DateTime $end_date) {}
  
  
  /**
   * Given an array of BookingEvents the calendar is updated with regards to the
   * events that are relevant to the Room this calendar refers to
   */
  public function updateCalendar(array $events) {
    
    $monthly_events = array();

    foreach ($events as $event){
      dpm($event);
      // Make sure event refers to the room for this calendar
      if ($event->room_id == $this->room_id) {  
        if ($event->sameMonth()) {
          $monthly_events[] = $event;
        }
        else {
          dpm($event);
          // It is easier to work with individual monthly events rather that
          // complicating table updates.
          $monthly_events_tmp = $event->transformToMonthlyEvents();
          $monthly_events =  array_merge($monthly_events, $montly_events_tmp);
        }
      }
    }
      
    //check for conflicts
          


    foreach($monthly_events as $event) {
      //$this->addMonthEvent($event);
    }
    
    //$date = new DateTime;
    
    /*$insert = db_insert('rooms_availability')
      ->fields(array(
        'rooms_room_id' => $this->room_id,
        'year' => 2011,
        'month' => $month,
        'd1'=>1,
        'd2'=>1,
        'd3'=>1,
        'd4'=>15,
      ));*/
      
    //$insert->execute();
  }
  
  /**
   * Adds an event to the calendar
   *
   * @param $event
   *   An array of events of type BookingEvent
   *
   * @return
   *   TRUE if events added, FALSE if some event failed
   */
  public function addMonthEvent($event) {
    // First check if the month exists and do an update if so
    if ($this->monthDefined($event->startMonth(), $event->startYear())) {
      //Do the update
    }
    // Do an insert for a new month
    else {
      // Prepare the days array
      $days = $this->prepareMonthArray($event->startDay(), $event->endDay());
      
      $month_row = array (
        'rooms_room_id' => $this->room_id,
        'year' => $event->startYear(),
        'month' => $event->startMonth(),        
      );
      $month_row = array_merge($month_row, $days);
      
      $insert = db_insert('rooms_availability')->fields($month_row);
      $insert->execute();
    }
  }
    
  
  protected function prepareMonthArray($start, $end){
    for ($i = 1; $i<=31; $i++) {
      if (($i >= $start) && ($i < $end)) {
        $days['d' . $i] = $event->id;
      } else {
        $days['d' . $i] = '0';
      }
    }
  }
  
  /**
   * Check if a month exists
   *
   * @return true - if the month is defined
   */
  public function monthDefined($month, $year) {
    $query = db_select('rooms_availability', 'a');
    $query->addField('a', 'rooms_room_id');
    $query->addField('a', 'year');
    $query->addField('a', 'month');
    $query->condition('a.rooms_room_id', $this->room_id);
    $query->condition('a.year', $year);
    $query->condition('a.month', $month);
    $result = $query->execute()->fetchAll(PDO::FETCH_ASSOC);;
    dpm($result);
    if (count($result) > 0) {
      return TRUE;
    } 
    return FALSE;
  }
  
  
}



class BookingEvent {
  
  // The room the event is relevant to
  public $room_id;
  
  // The start date for the event
  public $start_date;
  
  // The end date for the event
  public $end_date;
  
  // The type of event
  public $id;
  
  
  public function __construct($room_id, $event_id, $start_date, $end_date) {
    $this->room_id = $room_id;
    $this->id = $event_id;
    $this->start_date = $start_date;
    $this->end_date = $end_date;
  }
  
  public function startDay() {
    return $this->start_date->format('j');
  }
  
  public function startMonth() {
    return $this->start_date->format('n');
  }
  
  public function startYear() {
    return $this->start_date->format('Y');
  }
  
  public function endDay() {
    return $this->end_date->format('j');
  }
  
  public function endMonth() {
    return $this->end_date->format('n');
  }
  
  public function endYear() {
    return $this->end_date->format('Y');
  }

  public function diff() {
    $interval = $this->start_date->diff($this->end_date);
    return $interval;
  }
  
  public function sameMonth() {
    if (($this->startMonth() == $this->endMonth()) && ($this->startYear() == $this->endYear())) {
      return TRUE;
    }
    return FALSE;
  }
  
  public function sameYear() {
    if ($this->startYear == $this->endYear) {
      return TRUE;
    }
    return FALSE;    
  }
  
  /**
   * Takes a single event that spans several months and transforms it to
   * monthly events
   */
  public function transformToMonthlyEvents() {
    $events = array();
    // Create copies of the end and start dates
    $end = DateTime::createFromFormat('j-n-Y', $this->endDay().'-'.$this->endMonth().'-'.$this->endYear());
    $start = DateTime::createFromFormat('j-n-Y', $this->startDay().'-'.$this->startMonth().'-'.$this->startYear());
    
    $not_in_same_month = TRUE;
    while ($not_in_same_month) {        
      $interval = $end->diff($this->start_date);
      dpm($interval->m);
      if ($interval->m > 2){
        dpm(date('j', $end->getTimestamp()), 'thedate');
        $end->sub(new DateInterval('P'.date('j', $end->getTimestamp()).'D'));
        $end->add(new DateInterval('P1D'));
        
        $event = new BookingEvent($this->room_id, $this->id, new DateTime(date('j-n-Y', $end->getTimestamp())), new DateTime(date('j-n-Y', $this->end_date->getTimestamp())));
        
        $events[] = $event;
        $end->sub(new DateInterval('P1D'));
      //Compare the end date with the original start date to determine whether another month is available
        dpm($events, 'events');
        
      
        dpm($end, 'the copy');
        dpm($this->end_date, 'the original');  
      } else {
        dpm('in the same month');
        $not_in_same_month = FALSE;    
      }
      
    }
    
    
    //dpm($event, 'transform');
    //dpm($this->diff()->m);
    //$period = new DatePeriod($this->start_date, new DateInterval('P1M'), $this->end_date);
  
    //$interval = $this->start_date->diff($this->end_date);
    
    //dpm($interval->days, 'months');
    //dpm(date('t', $this->start_date->getTimestamp()));
    
    //while ($this->end_date )
    
    //dpm($this->end_date->sub(new DateInterval('P'.$this->endDay().'D')));
    //dpm($period);
    //foreach ($period as $month){
    //  dpm($month);
    //}
  }

  
}







